/*
 Copyright (c) 2010-2011, CloudMade, Vladimir Agafonkin
 Leaflet is a BSD-licensed JavaScript library for map display and interaction.
 See http://leaflet.cloudmade.com for more information.
*/
(function(a){a.gvector={VERSION:"0.1",ROOT_URL:function(){var a=document.getElementsByTagName("script"),c=/^(.*\/)gvector\-?([\w\-]*)\.js.*$/,d,e,f;d=0;for(e=a.length;d<e;d++)if(f=a[d].src,f=f.match(c)){if(f[2]==="include")break;return f[1]}return"../../dist/"}(),noConflict:function(){a.gvector=this._originalgvector;return this},_originalgvector:a.gvector}})(this);gvector.Util={extend:function(a){for(var b=Array.prototype.slice.call(arguments,1),c=0,d=b.length,e;c<d;c++){e=b[c]||{};for(var f in e)e.hasOwnProperty(f)&&(a[f]=e[f])}return a},bind:function(a,b){return function(){return a.apply(b,arguments)}},stamp:function(){var a=0;return function(b){b._gvector_id=b._gvector_id||++a;return b._gvector_id}}(),requestAnimFrame:function(){function a(a){window.setTimeout(a,1E3/60)}var b=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||
window.oRequestAnimationFrame||window.msRequestAnimationFrame||a;return function(c,d,e,f){c=d?gvector.Util.bind(c,d):c;e&&b===a?c():b(c,f)}}(),limitExecByInterval:function(a,b,c){function d(){e=!1;f&&(g.callee.apply(c,g),f=!1)}var e,f,g;return function(){g=arguments;e?f=!0:(e=!0,setTimeout(d,b),a.apply(c,g))}},falseFn:function(){return!1},formatNum:function(a,b){var c=Math.pow(10,b||5);return Math.round(a*c)/c},setOptions:function(a,b){a.options=gvector.Util.extend({},a.options,b)},getParamString:function(a){var b=
[],c;for(c in a)a.hasOwnProperty(c)&&b.push(c+"="+a[c]);return"?"+b.join("&")}};gvector.Class=function(){};
gvector.Class.extend=function(a){var b=function(){this.initialize&&this.initialize.apply(this,arguments)},c=function(){};c.prototype=this.prototype;c=new c;c.constructor=b;b.prototype=c;b.superclass=this.prototype;for(var d in this)this.hasOwnProperty(d)&&d!="prototype"&&d!="superclass"&&(b[d]=this[d]);a.statics&&(gvector.Util.extend(b,a.statics),delete a.statics);a.includes&&(gvector.Util.extend.apply(null,[c].concat(a.includes)),delete a.includes);if(a.options&&c.options)a.options=gvector.Util.extend({},
c.options,a.options);gvector.Util.extend(c,a);b.extend=arguments.callee;b.include=function(a){gvector.Util.extend(this.prototype,a)};return b};gvector.Layer=gvector.Class.extend({options:{fields:"",scaleRange:null,map:null,uniqueField:null,visibleAtScale:!0,dynamic:!1,autoUpdate:!1,autoUpdateInterval:null,infoWindowTemplate:null,symbology:null,showAll:!1},initialize:function(a){gvector.Util.setOptions(this,a)},_vectors:[],setMap:function(a){if((this.options.map=a)&&this.options.scaleRange&&this.options.scaleRange instanceof Array&&this.options.scaleRange.length===2){var b=this.options.map.getZoom(),c=this.options.scaleRange;this.options.visibleAtScale=
b>=c[0]&&b<=c[1]}this[a?"_show":"_hide"]()},getMap:function(){return this.options.map},setOptions:function(){},_show:function(){if(this.options.showAll)this._getFeatures();else if(this._addIdleListener(),this.options.scaleRange&&this.options.scaleRange instanceof Array&&this.options.scaleRange.length===2&&this._addZoomChangeListener(),this.options.visibleAtScale){if(this.options.autoUpdate&&this.options.autoUpdateInterval){var a=this;this._autoUpdateInterval=setInterval(function(){a._getFeatures()},
this.options.autoUpdateInterval)}google.maps.event.trigger(this.options.map,"zoom_changed");google.maps.event.trigger(this.options.map,"idle")}},_hide:function(){this._idleListener&&google.maps.event.removeListener(this._idleListener);this._zoomChangeListener&&google.maps.event.removeListener(this._zoomChangeListener);this._autoUpdateInterval&&clearInterval(this._autoUpdateInterval);this._clearFeatures();this._lastQueriedBounds=null},_hideVectors:function(){for(var a=0;a<this._vectors.length;a++)if(this._vectors[a].vector&&
(this._vectors[a].vector.setMap(null),this._vectors[a].infoWindow&&this._vectors[a].infoWindow.close()),this._vectors[a].vectors&&this._vectors[a].vectors.length)for(var b=0;b<this._vectors[a].vectors.length;b++)this._vectors[a].vectors[b].setMap(null),this._vectors[a].vectors[b].infoWindow&&this._vectors[a].vectors[b].infoWindow.close()},_showVectors:function(){for(var a=0;a<this._vectors.length;a++)if(this._vectors[a].vector&&this._vectors[a].vector.setMap(this.options.map),this._vectors[a].vectors&&
this._vectors[a].vectors.length)for(var b=0;b<this._vectors[a].vectors.length;b++)this._vectors[a].vectors[b].setMap(this.options.map)},_clearFeatures:function(){this._hideVectors();this._vectors=[]},_addZoomChangeListener:function(){var a=this;this._zoomChangeListener=google.maps.event.addListener(this.options.map,"zoom_changed",function(){a._checkLayerVisibility()})},_addIdleListener:function(){var a=this;this._idleListener=google.maps.event.addListener(this.options.map,"idle",function(){a.options.visibleAtScale&&
a._getFeatures()})},_checkLayerVisibility:function(){var a=this.options.visibleAtScale,b=this.options.map.getZoom(),c=this.options.scaleRange;this.options.visibleAtScale=b>=c[0]&&b<=c[1];if(a!==this.options.visibleAtScale)this[this.options.visibleAtScale?"_showVectors":"_hideVectors"]();if(a&&!this.options.visibleAtScale&&this._autoUpdateInterval)clearInterval(this._autoUpdateInterval);else if(!a&&this.options.autoUpdate&&this.options.autoUpdateInterval){var d=this;this._autoUpdateInterval=setInterval(function(){d._getFeatures()},
this.options.autoUpdateInterval)}},_setInfoWindowContent:function(a){var b=a.iwContent,c=a.attributes||a.properties,d=this.options.infoWindowTemplate,e;for(e in c)d=d.replace(RegExp("{"+e+"}","g"),c[e]);a.iwContent=d;a.infoWindow&&a.iwContent!=b&&a.infoWindow.setContent(a.iwContent)},_showInfoWindow:function(a,b){a.infoWindow=new google.maps.InfoWindow({content:a.iwContent});var c=this;setTimeout(function(){a.infoWindow.open(c.options.map,a.vector.getPaths||a.vector.getPath?new google.maps.Marker({position:b.latLng}):
a.vector)},200)},_buildBoundsString:function(a){a=a.toUrlValue().split(",");return a[1]+","+a[0]+","+a[3]+","+a[2]},_getFeatureVectorOptions:function(a){var b={},a=a.attributes||a.properties;if(this.options.symbology)switch(this.options.symbology.type){case "single":for(var c in this.options.symbology.vectorOptions)b[c]=this.options.symbology.vectorOptions[c];break;case "unique":for(var d=this.options.symbology.property,e=0,f=this.options.symbology.values.length;e<f;e++)if(a[d]==this.options.symbology.values[e].value)for(c in this.options.symbology.values[e].vectorOptions)b[c]=
this.options.symbology.values[e].vectorOptions[c];break;case "range":d=this.options.symbology.property;e=0;for(f=this.options.symbology.ranges.length;e<f;e++)if(a[d]>=this.options.symbology.ranges[e].range[0]&&a[d]<=this.options.symbology.ranges[e].range[1])for(c in this.options.symbology.ranges[e].vectorOptions)b[c]=this.options.symbology.ranges[e].vectorOptions[c]}return b},_getAttributesChanged:function(a,b){var c=!1,d;for(d in a)a[d]!=b[d]&&(c=!0);return c},_getGeometryChanged:function(){return!1},
_esriJsonToGoogle:function(a,b){var c;if(a.geometry.x&&a.geometry.y)b.position=new google.maps.LatLng(a.geometry.y,a.geometry.x),c=new google.maps.Marker(b);else if(a.geometry.paths){c=[];for(var d=0;d<a.geometry.paths.length;d++)for(var e=0;e<a.geometry.paths[d].length;e++)c.push(new google.maps.LatLng(a.geometry.paths[d][e][1],a.geometry.paths[d][e][0]));b.path=c;c=new google.maps.Polyline(b)}else if(a.geometry.rings){for(var f=[],d=0;d<a.geometry.rings.length;d++){c=[];for(e=0;e<a.geometry.rings[d].length;e++)c.push(new google.maps.LatLng(a.geometry.rings[d][e][1],
a.geometry.rings[d][e][0]));f.push(c)}b.paths=f;c=new google.maps.Polygon(b)}a.vector=c},_geojsonGeometryToGoogle:function(a,b){var c,d;switch(a.type){case "Point":b.position=new google.maps.LatLng(a.coordinates[1],a.coordinates[0]);c=new google.maps.Marker(b);break;case "LineString":c=[];for(var e=0;e<a.coordinates.length;e++){var f=new google.maps.LatLng(a.coordinates[e][1],a.coordinates[e][0]);c.push(f)}b.path=c;c=new google.maps.Polyline(b);break;case "Polygon":for(var g=[],e=0;e<a.coordinates.length;e++){c=
[];for(var h=0;h<a.coordinates[e].length;h++)f=new google.maps.LatLng(a.coordinates[e][h][1],a.coordinates[e][h][0]),c.push(f);g.push(c)}b.paths=g;c=new google.maps.Polygon(b);break;case "GeometryCollection":d=[];for(e=0;e<a.geometries.length;e++)d.push(this._geojsonGeometryToGoogle(a.geometries[e],b))}return c||d}});gvector.A2E=gvector.Layer.extend({initialize:function(a){if(!a.url)throw Error('No "url" parameter provided.');a.url.substr(a.url.length-1,1)!=="/"&&(a.url+="/");gvector.Layer.prototype.initialize.call(this,a);this._globalPointer="A2E_"+Math.floor(Math.random()*1E5);window[this._globalPointer]=this;if(this.options.map){if(this.options.scaleRange&&this.options.scaleRange instanceof Array&&this.options.scaleRange.length===2){var a=this.options.map.getZoom(),b=this.options.scaleRange;this.options.visibleAtScale=
a>=b[0]&&a<=b[1]}this._show()}},options:{url:null},_getFeatures:function(){var a=this.options.url+"search?f=gjson&q="+this.options.where+"&callback="+this._globalPointer+"._processFeatures";this.options.showAll||(a+="&bbox="+this._buildBoundsString(this.options.map.getBounds()));var b=document.getElementsByTagName("head")[0],c=document.createElement("script");c.type="text/javascript";c.src=a;b.appendChild(c)},_processFeatures:function(a){var b=this.options.map.getBounds();if(!this._lastQueriedBounds||
!this._lastQueriedBounds.equals(b))if(this._lastQueriedBounds=b,a&&a.features&&a.features.length)for(b=0;b<a.features.length;b++){var c=!1;if(a.features[b].id)for(var d=0;d<this._vectors.length;d++)this._vectors[d].id&&a.features[b].id==this._vectors[d].id&&(c=!0);if(!c){c=this._geojsonGeometryToGoogle(a.features[b].geometry,this._getFeatureVectorOptions(a.features[b]));a.features[b][c instanceof Array?"vectors":"vector"]=c;a.features[b].vector&&a.features[b].vector.setMap(this.options.map);if(a.features[b].vectors&&
a.features[b].vectors.length)for(c=0;c<a.features[b].vectors.length;c++)a.features[b].vectors[c].setMap(this.options.map);this._vectors.push(a.features[b]);if(this.options.infoWindowTemplate){var e=this,c=this._vectors[d];this._setInfoWindowContent(c);(function(a){google.maps.event.addListener(a.vector,"click",function(b){e._showInfoWindow(a,b)})})(c)}}}}});gvector.AGS=gvector.Layer.extend({initialize:function(a){if(!a.url)throw Error('No "url" parameter provided.');a.url.substr(a.url.length-1,1)!=="/"&&(a.url+="/");gvector.Layer.prototype.initialize.call(this,a);this._globalPointer="AGS_"+Math.floor(Math.random()*1E5);window[this._globalPointer]=this;if(this.options.map){if(this.options.scaleRange&&this.options.scaleRange instanceof Array&&this.options.scaleRange.length===2){var a=this.options.map.getZoom(),b=this.options.scaleRange;this.options.visibleAtScale=
a>=b[0]&&a<=b[1]}this._show()}},options:{where:"1=1",url:null},_getFeatures:function(){this.options.uniqueField||this._clearFeatures();var a=this.options.url+"query?returnGeometry=true&inSR=4326&outSR=4326&spatialRel=esriSpatialRelIntersects&f=json&outFields="+this.options.fields+"&where="+this.options.where+"&geometryType=esriGeometryEnvelope&callback="+this._globalPointer+"._processFeatures";this.options.showAll||(a+="&geometry="+this._buildBoundsString(this.options.map.getBounds()));var b=document.getElementsByTagName("head")[0],
c=document.createElement("script");c.type="text/javascript";c.src=a;b.appendChild(c)},_processFeatures:function(a){var b=this.options.map.getBounds();if(!this._lastQueriedBounds||!this._lastQueriedBounds.equals(b)||this._autoUpdateInterval)if(this._lastQueriedBounds=b,a&&a.features&&a.features.length)for(b=0;b<a.features.length;b++){var c=!1;if(this.options.uniqueField)for(var d=0;d<this._vectors.length;d++)if(a.features[b].attributes[this.options.uniqueField]==this._vectors[d].attributes[this.options.uniqueField]&&
(c=!0,this.options.dynamic)){if(!isNaN(a.features[b].geometry.x)&&!isNaN(a.features[b].geometry.y)&&!(a.features[b].geometry.x==this._vectors[d].geometry.x&&a.features[b].geometry.y==this._vectors[d].geometry.y))this._vectors[d].geometry=a.features[b].geometry,this._vectors[d].vector.setPosition(new google.maps.LatLng(this._vectors[d].geometry.y,this._vectors[d].geometry.x));if(this._getAttributesChanged(this._vectors[d].attributes,a.features[b].attributes))this._vectors[d].attributes=a.features[b].attributes,
this.options.infoWindowTemplate&&this._setInfoWindowContent(this._vectors[d]),this.options.symbology&&this.options.symbology.type!="single"&&this._vectors[d].vector.setOptions(this._getFeatureVectorOptions(this._vectors[d]))}if(!c||!this.options.uniqueField)if(this._esriJsonToGoogle(a.features[b],this._getFeatureVectorOptions(a.features[b])),a.features[b].vector.setMap(this.options.map),this._vectors.push(a.features[b]),this.options.infoWindowTemplate){var e=this,c=this._vectors[d];this._setInfoWindowContent(c);
(function(a){google.maps.event.addListener(a.vector,"click",function(b){e._showInfoWindow(a,b)})})(c)}}}});gvector.GeoIQ=gvector.Layer.extend({initialize:function(a){if(!a.dataset)throw Error('No "dataset" parameter provided.');gvector.Layer.prototype.initialize.call(this,a);this._globalPointer="GeoIQ_"+Math.floor(Math.random()*1E5);window[this._globalPointer]=this;if(this.options.map){if(this.options.scaleRange&&this.options.scaleRange instanceof Array&&this.options.scaleRange.length===2){var a=this.options.map.getZoom(),b=this.options.scaleRange;this.options.visibleAtScale=a>=b[0]&&a<=b[1]}this._show()}},
options:{dataset:null},_getFeatures:function(){this.options.uniqueField||this._clearFeatures();var a="http://geocommons.com/datasets/"+this.options.dataset+"/features.json?geojson=1&callback="+this._globalPointer+"._processFeatures&limit=999";this.options.showAll||(a+="&bbox="+this._buildBoundsString(this.options.map.getBounds())+"&intersect=full");var b=document.getElementsByTagName("head")[0],c=document.createElement("script");c.type="text/javascript";c.src=a;b.appendChild(c)},_processFeatures:function(a){var a=
JSON.parse(a),b=this.options.map.getBounds();if(!this._lastQueriedBounds||!this._lastQueriedBounds.equals(b))if(this._lastQueriedBounds=b,a&&a.features&&a.features.length)for(b=0;b<a.features.length;b++){var c=!1;if(this.options.uniqueField)for(var d=0;d<this._vectors.length;d++)a.features[b].properties[this.options.uniqueField]==this._vectors[d].properties[this.options.uniqueField]&&(c=!0);if(!c||!this.options.uniqueField){c=this._geojsonGeometryToGoogle(a.features[b].geometry,this._getFeatureVectorOptions(a.features[b]));
a.features[b][c instanceof Array?"vectors":"vector"]=c;a.features[b].vector&&a.features[b].vector.setMap(this.options.map);if(a.features[b].vectors&&a.features[b].vectors.length)for(c=0;c<a.features[b].vectors.length;c++)a.features[b].vectors[c].setMap(this.options.map);this._vectors.push(a.features[b]);if(this.options.infoWindowTemplate){var e=this,c=this._vectors[d];this._setInfoWindowContent(c);(function(a){google.maps.event.addListener(a.vector,"click",function(b){e._showInfoWindow(a,b)})})(c)}}}}});
